{% extends "admin/base.html" %}

{% block admin_content %}
<div class="page-header">
    <h1>Управление сайтами</h1>
    <p class="lead">Добавление и редактирование сайтов в группах</p>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">
                    <span class="glyphicon glyphicon-plus"></span> Добавить сайт
                </h3>
            </div>
            <div class="panel-body">
                <form method="POST" action="{{ url_for('add_site') }}">
                    <div class="form-group">
                        <label for="name">Название сайта:</label>
                        <input type="text" class="form-control" id="name" name="name"
                               placeholder="Например: Google" required>
                    </div>
                    <div class="form-group">
                        <label for="url">URL:</label>
                        <input type="url" class="form-control" id="url" name="url"
                               placeholder="https://www.example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Описание:</label>
                        <textarea class="form-control" id="description" name="description"
                                  rows="3" placeholder="Краткое описание сайта..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="icon_url">URL иконки (опционально):</label>
                        <input type="url" class="form-control" id="icon_url" name="icon_url"
                               placeholder="https://www.example.com/favicon.ico">
                        <small class="text-muted">Обычно favicon.ico или логотип сайта</small>
                    </div>
                    <div class="form-group">
                        <label for="group_id">Группа:</label>
                        <select class="form-control" id="group_id" name="group_id" required>
                            <option value="">Выберите группу</option>
                            {% for group in groups %}
                            <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">
                        <span class="glyphicon glyphicon-ok"></span> Добавить сайт
                    </button>
                </form>
            </div>
        </div>

        <!-- Статистика -->
        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">Статистика</h3>
            </div>
            <div class="panel-body">
                <p><strong>Всего сайтов:</strong> {{ sites|length }}</p>
                {% for group in groups %}
                <p><strong>{{ group.name }}:</strong> {{ group.sites|length }} сайт(ов)</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="panel panel-default">
            <div class="panel-heading">
                <div class="row">
                    <div class="col-md-6">
                        <h3 class="panel-title">
                            <span class="glyphicon glyphicon-list"></span> Список сайтов
                        </h3>
                    </div>
                    <div class="col-md-6 text-right">
                        <span class="badge">{{ sites|length }} всего</span>
                    </div>
                </div>
            </div>
            <div class="panel-body">
                {% if sites %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Иконка</th>
                                <th>Название</th>
                                <th>URL</th>
                                <th>Группа</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for site in sites %}
                            <tr>
                                <td>{{ site.id }}</td>
                                <td>
                                    {% if site.icon_url %}
                                    <img src="{{ site.icon_url }}" alt="{{ site.name }}"
                                         style="width: 24px; height: 24px; border-radius: 3px;"
                                         onerror="this.style.display='none'">
                                    {% else %}
                                    <span class="glyphicon glyphicon-globe text-muted"></span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ site.name }}</strong>
                                    {% if site.description %}
                                    <br><small class="text-muted">{{ site.description[:50] }}{% if site.description|length > 50 %}...{% endif %}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ site.url }}" target="_blank" title="{{ site.url }}">
                                        {{ site.url[:30] }}...
                                    </a>
                                </td>
                                <td>
                                    <span class="label label-primary">{{ site.group.name }}</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-xs">
                                        <button type="button" class="btn btn-primary"
                                                data-toggle="modal" data-target="#editSiteModal{{ site.id }}"
                                                title="Редактировать">
                                            <span class="glyphicon glyphicon-edit"></span>
                                        </button>
                                        <a href="{{ url_for('delete_site', id=site.id ) }}"
                                           class="btn btn-danger"
                                           onclick="return confirm('Удалить сайт \"{{ site.name }}\"?')"
                                           title="Удалить">
                                            <span class="glyphicon glyphicon-trash"></span>
                                        </a>
                                        <a href="{{ site.url }}" target="_blank" class="btn btn-info"
                                           title="Открыть сайт">
                                            <span class="glyphicon glyphicon-share"></span>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted">
                    <h4>Сайты не найдены</h4>
                    <p>Добавьте первый сайт используя форму слева.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальные окна для редактирования сайтов -->
{% for site in sites %}
<div class="modal fade" id="editSiteModal{{ site.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">
                    <span class="glyphicon glyphicon-edit"></span> Редактировать сайт
                </h4>
            </div>
            <form method="POST" action="{{ url_for('edit_site', id=site.id) }}">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="edit_name{{ site.id }}">Название сайта:</label>
                        <input type="text" class="form-control"
                               id="edit_name{{ site.id }}" name="name"
                               value="{{ site.name }}" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_url{{ site.id }}">URL:</label>
                        <input type="url" class="form-control"
                               id="edit_url{{ site.id }}" name="url"
                               value="{{ site.url }}" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_description{{ site.id }}">Описание:</label>
                        <textarea class="form-control"
                                  id="edit_description{{ site.id }}"
                                  name="description" rows="3">{{ site.description or '' }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit_icon_url{{ site.id }}">URL иконки:</label>
                        <input type="url" class="form-control"
                               id="edit_icon_url{{ site.id }}" name="icon_url"
                               value="{{ site.icon_url or '' }}">
                        <small class="text-muted">Оставьте пустым для иконки по умолчанию</small>
                    </div>
                    <div class="form-group">
                        <label for="edit_group_id{{ site.id }}">Группа:</label>
                        <select class="form-control" id="edit_group_id{{ site.id }}" name="group_id" required>
                            {% for group in groups %}
                            <option value="{{ group.id }}" {% if group.id == site.group_id %}selected{% endif %}>
                                {{ group.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        <span class="glyphicon glyphicon-remove"></span> Отмена
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span class="glyphicon glyphicon-ok"></span> Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}